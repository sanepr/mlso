name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'

jobs:
  lint:
    name: Code Linting
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint black isort
        pip install -r requirements.txt

    - name: Run flake8
      run: |
        # Stop build if there are Python syntax errors or undefined names
        flake8 src --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 src --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true

    - name: Run pylint
      run: |
        pylint src --disable=C0111,C0103,R0913,R0914 --exit-zero
      continue-on-error: true

    - name: Check code formatting with black
      run: |
        black --check src tests
      continue-on-error: true

    - name: Check import sorting with isort
      run: |
        isort --check-only src tests
      continue-on-error: true

    - name: Upload lint results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lint-results
        path: |
          ./**/*.log
        retention-days: 7

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-html
        pip install -r requirements.txt

    - name: Download dataset
      run: |
        python src/data/download_data.py
      continue-on-error: true

    - name: Run preprocessing
      run: |
        python src/data/preprocessing.py
      continue-on-error: true

    - name: Run unit tests
      run: |
        pytest tests/ -v \
          --cov=src \
          --cov-report=html \
          --cov-report=term \
          --cov-report=xml \
          --html=test-report.html \
          --self-contained-html \
          --junitxml=junit.xml

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          test-report.html
          junit.xml
          htmlcov/
        retention-days: 30

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: |
          coverage.xml
          htmlcov/
        retention-days: 30

    - name: Comment test results on PR
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always() && github.event_name == 'pull_request'
      with:
        files: junit.xml

  train-model:
    name: Train ML Models
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Download and preprocess data
      run: |
        python src/data/download_data.py
        python src/data/preprocessing.py

    - name: Train models
      run: |
        python src/models/train.py

    - name: Validate model performance
      run: |
        python -c "
        import json
        from pathlib import Path
        
        metadata_path = Path('models/best_model_metadata.json')
        if metadata_path.exists():
            with open(metadata_path, 'r') as f:
                metadata = json.load(f)
            
            accuracy = metadata.get('test_accuracy', 0)
            roc_auc = metadata.get('test_roc_auc', 0)
            
            print(f'Model Accuracy: {accuracy:.4f}')
            print(f'Model ROC-AUC: {roc_auc:.4f}')
            
            # Fail if performance is below threshold
            if accuracy < 0.70:
                raise ValueError(f'Model accuracy {accuracy} is below threshold 0.70')
            if roc_auc < 0.75:
                raise ValueError(f'Model ROC-AUC {roc_auc} is below threshold 0.75')
            
            print('✅ Model performance meets requirements')
        else:
            print('⚠️ Metadata file not found, skipping validation')
        "

    - name: Upload trained models
      uses: actions/upload-artifact@v4
      with:
        name: trained-models
        path: |
          models/*.pkl
          models/*.json
        retention-days: 90

    - name: Upload MLflow artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mlflow-artifacts
        path: |
          mlruns/
        retention-days: 30

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: train-model
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download trained models
      uses: actions/download-artifact@v4
      with:
        name: trained-models
        path: models/

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker image
      run: |
        docker build -t heart-disease-api:${{ github.sha }} .
        docker tag heart-disease-api:${{ github.sha }} heart-disease-api:latest

    - name: Test Docker image
      run: |
        # Start container
        docker run -d -p 8000:8000 --name test-api heart-disease-api:latest
        
        # Wait for container to start
        sleep 10
        
        # Test health endpoint
        curl -f http://localhost:8000/health || exit 1
        
        # Stop container
        docker stop test-api
        docker rm test-api

    - name: Save Docker image
      run: |
        docker save heart-disease-api:latest -o heart-disease-api.tar

    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: heart-disease-api.tar
        retention-days: 7

    # Uncomment to push to Docker Hub
    # - name: Login to Docker Hub
    #   uses: docker/login-action@v2
    #   with:
    #     username: ${{ secrets.DOCKER_USERNAME }}
    #     password: ${{ secrets.DOCKER_PASSWORD }}
    #
    # - name: Push to Docker Hub
    #   run: |
    #     docker tag heart-disease-api:latest ${{ secrets.DOCKER_USERNAME }}/heart-disease-api:latest
    #     docker tag heart-disease-api:latest ${{ secrets.DOCKER_USERNAME }}/heart-disease-api:${{ github.sha }}
    #     docker push ${{ secrets.DOCKER_USERNAME }}/heart-disease-api:latest
    #     docker push ${{ secrets.DOCKER_USERNAME }}/heart-disease-api:${{ github.sha }}

  generate-report:
    name: Generate Pipeline Report
    runs-on: ubuntu-latest
    needs: [lint, test, train-model, build-docker]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Generate summary report
      run: |
        echo "# CI/CD Pipeline Summary" > pipeline-summary.md
        echo "" >> pipeline-summary.md
        echo "**Workflow Run:** ${{ github.run_number }}" >> pipeline-summary.md
        echo "**Commit:** ${{ github.sha }}" >> pipeline-summary.md
        echo "**Branch:** ${{ github.ref_name }}" >> pipeline-summary.md
        echo "**Triggered by:** ${{ github.actor }}" >> pipeline-summary.md
        echo "" >> pipeline-summary.md
        echo "## Job Status" >> pipeline-summary.md
        echo "- Lint: ${{ needs.lint.result }}" >> pipeline-summary.md
        echo "- Test: ${{ needs.test.result }}" >> pipeline-summary.md
        echo "- Train Model: ${{ needs.train-model.result }}" >> pipeline-summary.md
        echo "- Build Docker: ${{ needs.build-docker.result }}" >> pipeline-summary.md
        echo "" >> pipeline-summary.md
        echo "## Artifacts Generated" >> pipeline-summary.md
        echo "- Lint results" >> pipeline-summary.md
        echo "- Test reports and coverage" >> pipeline-summary.md
        echo "- Trained models" >> pipeline-summary.md
        echo "- MLflow artifacts" >> pipeline-summary.md
        echo "- Docker image" >> pipeline-summary.md
        
        cat pipeline-summary.md

    - name: Upload pipeline summary
      uses: actions/upload-artifact@v4
      with:
        name: pipeline-summary
        path: pipeline-summary.md
        retention-days: 90

    - name: Comment summary on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('pipeline-summary.md', 'utf8');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

